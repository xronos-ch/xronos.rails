<% content_for :title, @site.name %>
<% content_for :meta_description, "Chronometric data for #{@site.name}, an archaeological site in #{@site.country}, including #{@site.c14s.count} radiocarbon dates, #{@site.typos.count} typological classifications, and #{@site.references.count} bibliographic references." %>

<header id="site-header" class="bg-light text-primary">
  <div class="container my-5">
    <h1 class="display-1"><%= @site.name %></h1>
    <h2 class="display-6">
      <%= xr_icon Site, {}, { style: "height: 2.5rem;" } %>
      <%= Site.label.humanize %> 
      <% if @site.country.present? %> in <%= @site.country.common_name %><%end%>
    </h2>
  </div>
</header>

<% unless @site.lat.blank? or @site.lng.blank? %>
  <section id="siteMap" class="bg-primary">
    <div style="height: 30rem; position: relative;"
         data-controller="map"
         data-map-style-value="show_site"
         data-map-target="container"
         data-map-base-map-value="Imagery"
         data-map-markers-data-value='<%= [@site].to_json.html_safe %>'>
    </div>
  </section>
<% end %>

<section id="site-details" class="bg-body">
  <div class="container my-5">
    <%= render "site_details", site: @site %>
    <% if can? :edit, Site %>
      <div class="text-end my-3">
        <%= link_to(edit_site_path, class: "btn btn-sm btn-primary", data: { "turbo_frame": "remote_modal" }) do %>
          <%= fa_icon "pencil", text: "Edit site details" %>
        <% end %>
      </div>
    <% end %>
  </div>
</section>

<section id="site-xrons" class="bg-body">
    <% unless @c14s.nil? %>
      <div id="site-c14s" class="container my-5">
        <h2>
          <%= xr_icon C14, {}, style: "height: 2rem" %>
          <%= C14.label.humanize.pluralize %>
          <small class="text-muted">(<%= @pagy_c14s.count %>)</small>
        </h2>
        <turbo-frame id="site-c14s-table">
          <div id="sites-c14s-toolbar" class="d-flex">
            <div class="ms-auto">
              <%= link_to fa_icon("download"), 
                c14s_path(format: :csv, c14: { sample: { contexts: { site_id: @site.id } } }), 
                class: "btn btn-sm btn-outline-primary", 
                title: "Download CSV" %>
            </div>
          </div>
          <%= render "c14s/table", c14s: @c14s %>
          <% unless @pagy_c14s.pages <= 1 %>
            <%== pagy_bootstrap_nav(@pagy_c14s) %>
          <% end %>
        </turbo-frame>
      </div>
    <%end%>

    <% unless @typos.nil? %>
      <div id="site-typos" class="container my-5">
        <h2>
          <%= xr_icon Typo, {}, style: "height: 2rem" %>
          <%= Typo.label.humanize.pluralize %>
          <small class="text-muted">(<%= @pagy_typos.count %>)</small>
        </h2>
        <turbo-frame id="site-typos-table">
          <div id="sites-typos-toolbar" class="d-flex">
            <div class="ms-auto">
              <%= link_to fa_icon("download"), 
                typos_path(format: :csv, typo: { sample: { contexts: { site_id: @site.id } } }), 
                class: "btn btn-sm btn-outline-primary", 
                title: "Download CSV" %>
            </div>
          </div>
          <%= render "typos/table", typos: @typos %>
          <% unless @pagy_typos.pages <= 1 %>
            <%== pagy_bootstrap_nav(@pagy_typos) %>
          <% end %>
        </turbo-frame>
      </div>
    <%end%>

  </div>
</section>

<section id="references" class="bg-body">
  <div class="container my-5">
    <h2>
      <%= xr_icon Reference, {}, style: "height: 2rem" %>
      <%= Reference.label.humanize.pluralize %>
      <small class="text-muted">(<%# @site.recursive_references.count %>)</small>
    </h2>
    <%= render "references/bibliography", 
      references: @site.recursive_references %>
  </div>
</section>

<section id="xronos-metadata" class="bg-light">
  <div class="container my-5">

    <div class="my-5">
      <h2>Metadata</h2>
      <%= render "shared/record_metadata", record: @site, record_label: Site.label %>
    </div>

    <div class="my-5">
      <h2>Changelog</h2>
      <%= render "application/paper_trail/versions", item: @site %>
    </div>

</section>

<% if can? :manage, Site %>
  <section id="show-curation" class="bg-light">
    <div class="container my-5">

      <h2>Curation</h2>

      <% if @site.is_duplicated? %>
        <div class="my-3">
          <h3>Potential duplicates</h3>
          <%= render "table", sites: @site.duplicates %>
        </div>
      <% end %>

    </div>
  </section>
<% end %>
